<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AF BoardDocs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    #filters { margin-bottom: 1rem; }
    canvas { max-width: 800px; margin: 2rem auto; display: block; }
    select[multiple] { min-width: 130px; min-height: 2.1em; }
    .truncate-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 280px;
      cursor: pointer;
      transition: all 0.15s;
    }
    tr.expanded .truncate-cell {
      white-space: normal !important;
      overflow: visible !important;
      text-overflow: initial !important;
      max-width: 900px !important;
      word-break: break-word;
      background: #f8f8f8;
      z-index: 2;
      position: relative;
    }
    tr.expanded { background: #fafafa !important; }
  </style>
</head>
<body>
 
  <div id="nav-placeholder"></div>
  <script>
    fetch("nav.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("nav-placeholder").innerHTML = data;
      });
  </script>

  <h1>Homepage</h1>
  <script>
    document.title = document.querySelector("h1")?.innerText || "AF BoardDocs Dash";
  </script>

  <div id="filters">
    <label>Filter by Year:
      <select id="yearFilter" multiple></select>
    </label>
    <label>Filter by Category:
      <select id="categoryFilter" multiple></select>
    </label>
    <button id="applyFiltersBtn">Filter</button>
    <button id="clearFiltersBtn">Clear Filters</button>
  </div>

  <table id="agendaTable" class="display" width="100%">
    <thead>
      <tr>
        <th>Year</th>
        <th>Date</th>
        <th>Agenda #</th>
        <th>Title</th>
        <th>Category</th>
        <th>Type</th>
        <th>Recommended Action</th>
        <th>Moved By</th>
        <th>Seconded By</th>
        <th>Vote Result</th>
        <th>Yes</th>
        <th>No</th>
        <th>Abstain</th>
        <th>Attachments</th>
      </tr>
    </thead>
  </table>

  <canvas id="voteChart"></canvas>

<script>
const chunkedFiles = [
  "data/master_2013_2017.json",
  "data/master_2018_2020.json",
  "data/master_2021_2024.json",
  "data/2025_combined.json"
];

// Strict category normalization with typo/variant handling
function normalizeCategories(cat) {
  if (!cat) return ["Other"];
  cat = cat.replace(/^\d+\.*\s*-*\s*/g, '').toLowerCase().trim();

  const map = [
    { tag: "Call to Order", regex: /call to order/ },
    { tag: "Pledge of Allegiance", regex: /pledge of allegiance/ },
    { tag: "Information", regex: /information|discussion|presentation|informational/ },
    { tag: "Recognition/Celebration", regex: /recognition|recognize|recognitions|celebration|presentations? and celebrations?/ },
    { tag: "Call to the Public", regex: /call to the public|public comments?/ },
    { tag: "Approval of Minutes", regex: /approval of minutes|meeting minutes|minutes/ },
    { tag: "Action Items", regex: /action items?/ },
    { tag: "Consent Agenda Items", regex: /consent agenda/ },
    { tag: "Future Agenda Items", regex: /future agenda/ },
    { tag: "Return to Regular Session", regex: /return to regular session|reconvene|resturn to regular session|reconvene regular board meeting|reconvene meeting|reconvene the regular board meeting|reconvene to regular session/ },
    { tag: "Adjournment", regex: /adjourn(ment)?|adjourn excutive session|adjourn exutive session|adjourn excutiv(e)? session/ },
    { tag: "Executive Session", regex: /executive session|executive sesssion|excutive session|exective session/ },
    { tag: "Public Hearing", regex: /public hearing/ },
    { tag: "Oath of Office/Election of Governing Board Officers", regex: /oath of office|election of governing board officers|nomination|nominations and election|election of governing board officers for/ },
    { tag: "Board Advisory Committee", regex: /advisory committee/ }
  ];

  const tags = [];
  for (let m of map) {
    if (cat.match(m.regex)) tags.push(m.tag);
  }
  if (tags.length === 0) tags.push("Other");
  return [...new Set(tags)];
}

let allAgendaItems = [];
let table;

async function loadAllAgendaItems(files) {
  const meetings = [];
  for (let file of files) {
    try {
      const resp = await fetch(file);
      const json = await resp.json();
      meetings.push(...json);
    } catch (e) {
      console.error("Failed to load", file, e);
    }
  }
  // Flatten all agenda items
  const items = [];
  meetings.forEach(meeting => {
    (meeting.agenda_items || []).forEach(item => {
      let yes = 0, no = 0, abstain = 0;
      let moved_by = "", seconded_by = "";
      let vote_result = "";
      if (item.motion_and_voting) {
        const mv = item.motion_and_voting;
        vote_result = mv.vote_result || "";
        moved_by = mv.moved_by || "";
        seconded_by = mv.seconded_by || "";
        if (Array.isArray(mv.votes)) {
          mv.votes.forEach(v => {
            if (!v || !v.vote) return;
            if (v.vote === "Yes") yes++;
            else if (v.vote === "No") no++;
            else if (v.vote === "Abstain") abstain++;
          });
        }
      }
      let attachment_links = "";
      if (Array.isArray(item.attachments) && item.attachments.length) {
        attachment_links = item.attachments.map(a =>
          `<a href="${a.url}" target="_blank">${a.filename || a.label || "File"}</a>`
        ).join(", ");
      }
      const normCats = normalizeCategories(item.category);
      items.push({
        year: (meeting.meeting_date || "").slice(0, 4),
        meeting_date: meeting.meeting_date,
        agenda_number: item.number,
        title: item.title,
        category: normCats,
        type: item.type,
        recommended_action: item.recommendedAction,
        moved_by: moved_by,
        seconded_by: seconded_by,
        vote_result: vote_result,
        yes_votes: yes,
        no_votes: no,
        abstain_votes: abstain,
        attachment_links: attachment_links
      });
    });
  });
  return items;
}

function populateFilters(data) {
  const years = [...new Set(data.map(r => r.year))].filter(Boolean).sort();
  const categories = [...new Set(data.flatMap(r => r.category || []) )].filter(Boolean).sort();

  for (const y of years) {
    $('#yearFilter').append(`<option value="${y}">${y}</option>`);
  }
  for (const c of categories) {
    $('#categoryFilter').append(`<option value="${c}">${c}</option>`);
  }
}

function updateChart(data) {
  const result = { Yes: 0, No: 0, Abstain: 0 };
  data.forEach(row => {
    result.Yes += Number(row.yes_votes) || 0;
    result.No += Number(row.no_votes) || 0;
    result.Abstain += Number(row.abstain_votes) || 0;
  });
  const ctx = document.getElementById('voteChart').getContext('2d');
  if (window.voteChart) window.voteChart.destroy();
  window.voteChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(result),
      datasets: [{
        label: 'Total Votes',
        data: Object.values(result),
      }]
    }
  });
}

(async function(){
  allAgendaItems = await loadAllAgendaItems(chunkedFiles);
  populateFilters(allAgendaItems);

  table = $('#agendaTable').DataTable({
    data: allAgendaItems,
    columns: [
      { data: "year" },
      { data: "meeting_date" },
      { data: "agenda_number" },
      { data: "title" },
      {
        data: "category",
        render: cats => Array.isArray(cats) ? cats.join(", ") : cats
      },
      { data: "type" },
      {
        data: "recommended_action",
        render: function (data, type, row, meta) {
          if (!data) return "";
          if (type === 'display') {
            return `<div class="truncate-cell" title="Click row to expand/collapse">${data}</div>`;
          }
          return data;
        }
      },
      { data: "moved_by" },
      { data: "seconded_by" },
      { data: "vote_result" },
      { data: "yes_votes" },
      { data: "no_votes" },
      { data: "abstain_votes" },
      { data: "attachment_links" }
    ]
  });

  updateChart(allAgendaItems);

  // Only filter when button is clicked
  $('#applyFiltersBtn').on('click', function () {
    const y = $('#yearFilter').val();
    const c = $('#categoryFilter').val();
    const filtered = allAgendaItems.filter(r =>
      (!y || y.includes(r.year)) &&
      (!c || (r.category || []).some(cat => c.includes(cat)))
    );
    table.clear().rows.add(filtered).draw();
    updateChart(filtered);
  });

  // Clear filters button
  $('#clearFiltersBtn').on('click', function() {
    $('#yearFilter').val([]);
    $('#categoryFilter').val([]);
    table.clear().rows.add(allAgendaItems).draw();
    updateChart(allAgendaItems);
  });

  // Row expand/collapse for recommended_action (robust for DataTables redraw)
  $('#agendaTable tbody').on('click', 'td', function () {
    var tr = $(this).closest('tr');
    tr.toggleClass('expanded');
  });
})();
</script>

</body>
</html>
