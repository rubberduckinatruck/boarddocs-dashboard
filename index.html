<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AF BoardDocs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    #filters { margin-bottom: 1rem; }
    canvas { max-width: 800px; margin: 2rem auto; display: block; }
  </style>
</head>
<body>
 
  <div id="nav-placeholder"></div>
  <script>
    fetch("nav.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("nav-placeholder").innerHTML = data;
      });
  </script>

  <h1>Homepage</h1>
  <script>
    document.title = document.querySelector("h1")?.innerText || "AF BoardDocs Dash";
  </script>

  <div id="filters">
    <label>Filter by Year:
      <select id="yearFilter" multiple></select>
    </label>
    <label>Filter by Board Member:
      <select id="memberFilter" multiple></select>
    </label>
    <label>Filter by Category:
      <select id="categoryFilter" multiple></select>
    </label>
    <button id="clearFiltersBtn">Clear Filters</button>
  </div>

  <table id="agendaTable" class="display" width="100%">
    <thead>
      <tr>
        <th>Year</th>
        <th>Date</th>
        <th>Agenda #</th>
        <th>Title</th>
        <th>Category</th>
        <th>Type</th>
        <th>Recommended Action</th>
        <th>Moved By</th>
        <th>Seconded By</th>
        <th>Vote Result</th>
        <th>Yes</th>
        <th>No</th>
        <th>Abstain</th>
        <th>Attachments</th>
      </tr>
    </thead>
  </table>

  <canvas id="voteChart"></canvas>

<script>
const chunkedFiles = [
  "data/master_2013_2017.json",
  "data/master_2018_2020.json",
  "data/master_2021_2024.json",
  "data/2025_combined.json"
];

let allAgendaItems = [];
let table;

async function loadAllAgendaItems(files) {
  const meetings = [];
  for (let file of files) {
    try {
      const resp = await fetch(file);
      const json = await resp.json();
      meetings.push(...json);
    } catch (e) {
      console.error("Failed to load", file, e);
    }
  }
  // Flatten all agenda items
  const items = [];
  meetings.forEach(meeting => {
    (meeting.agenda_items || []).forEach(item => {
      // Compute Yes/No/Abstain counts per item from votes array (if present)
      let yes = 0, no = 0, abstain = 0;
      let moved_by = "", seconded_by = "";
      let vote_result = "";
      if (item.motion_and_voting) {
        const mv = item.motion_and_voting;
        vote_result = mv.vote_result || "";
        moved_by = mv.moved_by || "";
        seconded_by = mv.seconded_by || "";
        if (Array.isArray(mv.votes)) {
          mv.votes.forEach(v => {
            if (!v || !v.vote) return;
            if (v.vote === "Yes") yes++;
            else if (v.vote === "No") no++;
            else if (v.vote === "Abstain") abstain++;
          });
        }
      }
      // Attachments rendering (optional: can join names/urls)
      let attachment_links = "";
      if (Array.isArray(item.attachments) && item.attachments.length) {
        attachment_links = item.attachments.map(a =>
          `<a href="${a.url}" target="_blank">${a.filename || a.label || "File"}</a>`
        ).join(", ");
      }

      items.push({
        year: (meeting.meeting_date || "").slice(0, 4),
        meeting_date: meeting.meeting_date,
        agenda_number: item.number,
        title: item.title,
        category: item.category,
        type: item.type,
        recommended_action: item.recommendedAction,
        moved_by: moved_by,
        seconded_by: seconded_by,
        vote_result: vote_result,
        yes_votes: yes,
        no_votes: no,
        abstain_votes: abstain,
        attachment_links: attachment_links
      });
    });
  });
  return items;
}

function populateFilters(data) {
  const years = [...new Set(data.map(r => r.year))].filter(Boolean).sort();
  const members = new Set();
  const categories = [...new Set(data.map(r => r.category).filter(Boolean))].sort();

  // For member filter, you'd need to flatten all votes per item and get unique names:
  data.forEach(row => {
    // No per-member list in table, so skip for now unless you want to add it
  });

  for (const y of years) {
    $('#yearFilter').append(`<option value="${y}">${y}</option>`);
  }
  // Remove member filter if not used, or keep blank
  // for (const m of [...members].sort()) {
  //   if (m) $('#memberFilter').append(`<option value="${m}">${m}</option>`);
  // }
  for (const c of categories) {
    $('#categoryFilter').append(`<option value="${c}">${c}</option>`);
  }
}

function updateChart(data) {
  const result = { Yes: 0, No: 0, Abstain: 0 };
  data.forEach(row => {
    result.Yes += Number(row.yes_votes) || 0;
    result.No += Number(row.no_votes) || 0;
    result.Abstain += Number(row.abstain_votes) || 0;
  });
  const ctx = document.getElementById('voteChart').getContext('2d');
  if (window.voteChart) window.voteChart.destroy();
  window.voteChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: Object.keys(result),
      datasets: [{
        label: 'Total Votes',
        data: Object.values(result),
      }]
    }
  });
}

(async function(){
  allAgendaItems = await loadAllAgendaItems(chunkedFiles);
  populateFilters(allAgendaItems);

  table = $('#agendaTable').DataTable({
    data: allAgendaItems,
    columns: [
      { data: "year" },
      { data: "meeting_date" },
      { data: "agenda_number" },
      { data: "title" },
      { data: "category" },
      { data: "type" },
      { data: "recommended_action" },
      { data: "moved_by" },
      { data: "seconded_by" },
      { data: "vote_result" },
      { data: "yes_votes" },
      { data: "no_votes" },
      { data: "abstain_votes" },
      { data: "attachment_links" }
    ]
  });

  updateChart(allAgendaItems);

  // Filters
  $('#yearFilter, #categoryFilter').on('change', function () {
    const y = $('#yearFilter').val();
    // const m = $('#memberFilter').val(); // Remove if not used
    const c = $('#categoryFilter').val();

    const filtered = allAgendaItems.filter(r =>
      (!y || y.includes(r.year)) &&
      (!c || c.includes(r.category))
    );

    table.clear().rows.add(filtered).draw();
    updateChart(filtered);
  });

  // Clear filters button
  $('#clearFiltersBtn').on('click', function() {
    $('#yearFilter').val([]);
    // $('#memberFilter').val([]);
    $('#categoryFilter').val([]);
    table.clear().rows.add(allAgendaItems).draw();
    updateChart(allAgendaItems);
  });
})();
</script>

</body>
</html>
