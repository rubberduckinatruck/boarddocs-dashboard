<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AF BoardDocs Dash â€“ Categories</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    .chart-container {
      max-width: 700px;
      margin: 2rem auto;
      height: 360px;
    }
    canvas {
      height: 100% !important;
      max-width: 100%;
      display: block;
    }
    #filters label { display: inline-block; margin-right: 2em; }
    #filters select[multiple] {
      min-width: 150px; min-height: 7em; background: #fafcff; border: 1px solid #ddd;
      font-size: 1rem; margin-right: 1em; margin-bottom: 0.6em;
    }
    #categorySelect { font-size: 1rem; padding: 0.3rem 1rem; }
    #categoryTable { width: 100%; margin-top: 2rem; }
    tfoot input { width: 98%; padding: 2px; box-sizing: border-box; }
  </style>
</head>
<body>
  <!-- Nav -->
  <div id="nav-placeholder"></div>
  <script>
    fetch("nav.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("nav-placeholder").innerHTML = data;
      });
  </script>

  <h1>Category Frequency</h1>
  <p>
    <b>Purpose:</b> Explore which categories are most used (e.g. Personnel, Consent, Policy)<br>
    <b>Actionable Uses:</b><br>
    Spot under-discussed areas (e.g. curriculum rarely updated?)<br>
    Show trends in what board prioritizes over time
  </p>

  <div id="filters" style="margin:1.5rem 0;">
    <label>Filter by Year:
      <select id="yearFilter" multiple></select>
    </label>
    <label>Filter by Tag:
      <select id="tagFilter" multiple></select>
    </label>
    <button id="clearFiltersBtn">Clear Filters</button>
  </div>

  <div class="chart-container">
    <canvas id="pieChart"></canvas>
  </div>
  <div style="text-align:center; margin-bottom:1rem;">
    <label for="categorySelect"><b>See Trends By Category:</b> </label>
    <select id="categorySelect"></select>
  </div>
  <div class="chart-container">
    <canvas id="barChart"></canvas>
  </div>

  <h3 id="tableTitle" style="margin-top:2rem;">Agenda Items in <span id="categoryName"></span></h3>
  <table id="categoryTable" class="display">
    <thead>
      <tr>
        <th>Date</th>
        <th>Title</th>
        <th>Type</th>
        <th>Tags</th>
        <th>Red Flag</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th>Date</th>
        <th>Title</th>
        <th>Type</th>
        <th>Tags</th>
        <th>Red Flag</th>
      </tr>
    </tfoot>
    <tbody></tbody>
  </table>

<script>
// --- Strict normalization ---
function normalizeCategories(cat) {
  if (!cat) return ["Other"];
  cat = cat.replace(/^\d+\.*\s*-*\s*/g, '').toLowerCase().trim();
  const map = [
    { tag: "Call to Order", regex: /call to order/ },
    { tag: "Pledge of Allegiance", regex: /pledge of allegiance/ },
    { tag: "Information", regex: /information|discussion|presentation|informational/ },
    { tag: "Recognition/Celebration", regex: /recognition|recognize|recognitions|celebration|presentations? and celebrations?/ },
    { tag: "Call to the Public", regex: /call to the public|public comments?/ },
    { tag: "Approval of Minutes", regex: /approval of minutes|meeting minutes|minutes/ },
    { tag: "Action Items", regex: /action items?/ },
    { tag: "Consent Agenda Items", regex: /consent agenda/ },
    { tag: "Future Agenda Items", regex: /future agenda/ },
    { tag: "Return to Regular Session", regex: /return to regular session|reconvene|resturn to regular session|reconvene regular board meeting|reconvene meeting|reconvene the regular board meeting|reconvene to regular session/ },
    { tag: "Adjournment", regex: /adjourn(ment)?|adjourn excutive session|adjourn exutive session|adjourn excutiv(e)? session/ },
    { tag: "Executive Session", regex: /executive session|executive sesssion|excutive session|exective session/ },
    { tag: "Public Hearing", regex: /public hearing/ },
    { tag: "Oath of Office/Election of Governing Board Officers", regex: /oath of office|election of governing board officers|nomination|nominations and election|election of governing board officers for/ },
    { tag: "Board Advisory Committee", regex: /advisory committee/ }
  ];
  const tags = [];
  for (let m of map) {
    if (cat.match(m.regex)) tags.push(m.tag);
  }
  if (tags.length === 0) tags.push("Other");
  return [...new Set(tags)];
}

let pieChart, barChart, table;

function countCategories(data) {
  const counts = {};
  data.forEach(item => {
    const cats = Array.isArray(item.category) ? item.category : normalizeCategories(item.category);
    cats.forEach(cat => {
      counts[cat] = (counts[cat] || 0) + 1;
    });
  });
  return counts;
}

function getAllYears(data) {
  return [...new Set(data.map(item => (item.meeting_date || '').slice(0,4)))].filter(Boolean).sort();
}

function getAllTags(data) {
  // If using union_impact_tags, change .tags to .union_impact_tags
  const tagSet = new Set();
  data.forEach(item => {
    (Array.isArray(item.tags) ? item.tags : []).forEach(tag => {
      if (tag) tagSet.add(tag);
    });
  });
  return Array.from(tagSet).sort();
}

function countByYear(data, category) {
  const yearCounts = {};
  data.forEach(item => {
    const cats = Array.isArray(item.category) ? item.category : normalizeCategories(item.category);
    if (cats.includes(category)) {
      const year = (item.meeting_date || '').slice(0,4);
      if (year) yearCounts[year] = (yearCounts[year] || 0) + 1;
    }
  });
  return yearCounts;
}

function updatePieChart(counts) {
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  const cats = sorted.map(e => e[0]);
  const nums = sorted.map(e => e[1]);
  if (pieChart) pieChart.destroy();
  const ctx = document.getElementById("pieChart").getContext("2d");
  pieChart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: cats,
      datasets: [{ data: nums }]
    },
    options: {
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        title: {
          display: true,
          text: "Most Frequent Categories (Filtered)"
        }
      }
    }
  });
}

function updateBarChart(yearCounts, category) {
  const years = Object.keys(yearCounts).sort();
  const vals = years.map(y => yearCounts[y]);
  if (barChart) barChart.destroy();
  const ctx = document.getElementById("barChart").getContext("2d");
  barChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: years,
      datasets: [{
        label: category,
        data: vals
      }]
    },
    options: {
      maintainAspectRatio: false,
      animation: false,
      plugins: {
        title: {
          display: true,
          text: `Yearly Frequency: ${category} (Filtered)`
        }
      },
      scales: {
        y: { beginAtZero:true }
      }
    }
  });
}

function updateTable(data, category) {
  const filtered = data.filter(item => {
    const cats = Array.isArray(item.category) ? item.category : normalizeCategories(item.category);
    return cats.includes(category);
  });
  $("#categoryName").text(category);
  $("#tableTitle").toggle(filtered.length > 0);

  if ($('#categoryTable tfoot input').length === 0) {
    $('#categoryTable tfoot th').each(function() {
      $(this).html('<input type="text" placeholder="Search" />');
    });
  }

  if (table) table.destroy();
  table = $("#categoryTable").DataTable({
    data: filtered,
    columns: [
      { data: "meeting_date" },
      { data: "title" },
      { data: "type" },
      { data: "tags", render: tags => tags && tags.length ? tags.join(", ") : "" },
      { data: "red_flag", render: f => f ? "ðŸš©" : "" }
    ],
    order: [[0, "desc"]],
    initComplete: function () {
      this.api().columns().every(function () {
        var that = this;
        $('input', this.footer()).off().on('keyup change clear', function () {
          if (that.search() !== this.value) {
            that.search(this.value).draw();
          }
        });
      });
    }
  });
}

// Filtering function
function filterData(allAgendaItems, selectedYears, selectedTags) {
  return allAgendaItems.filter(item => {
    // Year filter
    const year = (item.meeting_date || '').slice(0,4);
    if (selectedYears.length && !selectedYears.includes(year)) return false;
    // Tag filter
    if (selectedTags.length) {
      if (!Array.isArray(item.tags) || !item.tags.some(tag => selectedTags.includes(tag))) return false;
    }
    return true;
  });
}

// MAIN DATA LOAD: fetch and merge both files, flatten agenda_items
Promise.all([
  fetch("data/master_2013to2024_cleaned.json").then(res => res.json()),
  fetch("data/2025_cleaned.json").then(res => res.json())
]).then(([data1, data2]) => {
  // Merge and flatten
  let meetings = Array.isArray(data1) && Array.isArray(data2)
    ? [...data1, ...data2]
    : (Array.isArray(data1) ? data1 : []).concat(Array.isArray(data2) ? data2 : []);
  let allAgendaItems = [];
  for (const meeting of meetings) {
    if (Array.isArray(meeting.agenda_items)) {
      for (const item of meeting.agenda_items) {
        allAgendaItems.push({ ...item, meeting_date: meeting.meeting_date });
      }
    }
  }
  allAgendaItems = allAgendaItems.map(item => ({
    ...item,
    category: Array.isArray(item.category) ? item.category : normalizeCategories(item.category),
    tags: Array.isArray(item.tags) ? item.tags : []
  }));

  // Populate year and tag filters
  const years = getAllYears(allAgendaItems);
  const tags = getAllTags(allAgendaItems);
  $('#yearFilter').empty();
  $('#tagFilter').empty();
  for (const y of years) $('#yearFilter').append(`<option value="${y}">${y}</option>`);
  for (const t of tags) $('#tagFilter').append(`<option value="${t}">${t}</option>`);

  // Filtering logic
  function refreshView() {
    const selectedYears = $('#yearFilter').val() || [];
    const selectedTags = $('#tagFilter').val() || [];
    const filteredItems = filterData(allAgendaItems, selectedYears, selectedTags);
    const catCounts = countCategories(filteredItems);

    // If no categories, blank the view
    if (!Object.keys(catCounts).length) {
      if (pieChart) pieChart.destroy();
      if (barChart) barChart.destroy();
      $("#categorySelect").empty();
      updateTable([], "");
      return;
    }

    updatePieChart(catCounts);

    // Re-populate category select with only categories in filtered view
    const sortedCats = Object.keys(catCounts).sort();
    $("#categorySelect").empty();
    for (const cat of sortedCats) {
      $("#categorySelect").append(`<option value="${cat}">${cat}</option>`);
    }

    let initialCat = $("#categorySelect").val() || sortedCats[0];
    $("#categorySelect").val(initialCat);

    const yearCounts = countByYear(filteredItems, initialCat);
    updateBarChart(yearCounts, initialCat);
    updateTable(filteredItems, initialCat);

    $("#categorySelect").off("change").on("change", function() {
      const selectedCat = $(this).val();
      const yrCounts = countByYear(filteredItems, selectedCat);
      updateBarChart(yrCounts, selectedCat);
      updateTable(filteredItems, selectedCat);
    });
  }

  // Initial render
  refreshView();

  // On filter change
  $('#yearFilter, #tagFilter').on('change', refreshView);
  $('#clearFiltersBtn').on('click', function() {
    $('#yearFilter').val([]).trigger('change');
    $('#tagFilter').val([]).trigger('change');
    refreshView();
  });
});
</script>
</body>
</html>
