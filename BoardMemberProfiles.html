<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AF BoardDocs Dash â€“ Board Member Profiles</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    canvas { max-width: 1000px; margin: 2rem auto; display: block; }
    table { width: 100%; margin-top: 2rem; border-collapse: collapse; }
    th, td { padding: 0.5rem; text-align: center; border: 1px solid #ddd; }
    th { background-color: #f4f4f4; }
  </style>
</head>
<body>

  <div id="nav-placeholder"></div>
  <script>
    fetch("nav.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("nav-placeholder").innerHTML = data;
      });
  </script>

  <h1>Board Member Profile</h1>
  <script>
    document.title = document.querySelector("h1")?.innerText || "AF BoardDocs Dash";
  </script>

  <p><b>Purpose:</b> View how each member votes over time</p>
  <p><b>Actionable Uses:</b><br>
    Strengthen public testimony with member-specific data<br>
    Identify allies/opponents for advocacy efforts</p>

  <canvas id="voteBreakdownChart"></canvas>

  <table id="voteTable">
    <thead>
      <tr>
        <th>Board Member</th>
        <th>Yes Votes</th>
        <th>No Votes</th>
        <th>Abstain Votes</th>
        <th>Total Votes</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
const chunkedFiles = [
  "data/master_2013_2017.json",
  "data/master_2018_2020.json",
  "data/master_2021_2024.json",
  "data/2025_combined.json"
];

async function loadAllMeetings(files) {
  const allMeetings = [];
  for (let file of files) {
    try {
      const resp = await fetch(file);
      const json = await resp.json();
      allMeetings.push(...json);
    } catch (e) {
      console.error("Failed to load", file, e);
    }
  }
  return allMeetings;
}

function tallyVotes(meetings) {
  const voteTally = {};
  meetings.forEach(meeting => {
    (meeting.agenda_items || []).forEach(item => {
      const mv = item.motion_and_voting || {};
      const votesArr = Array.isArray(mv.votes) ? mv.votes : [];
      votesArr.forEach(v => {
        if (!v || !v.name) return;
        if (!voteTally[v.name]) voteTally[v.name] = { yes: 0, no: 0, abstain: 0 };
        if (v.vote === "Yes") voteTally[v.name].yes++;
        else if (v.vote === "No") voteTally[v.name].no++;
        else if (v.vote === "Abstain") voteTally[v.name].abstain++;
      });
    });
  });
  return voteTally;
}

(async function() {
  const meetings = await loadAllMeetings(chunkedFiles);
  const voteTally = tallyVotes(meetings);

  const members = Object.keys(voteTally).sort();
  const yesCounts = members.map(m => voteTally[m].yes);
  const noCounts = members.map(m => voteTally[m].no);
  const abstainCounts = members.map(m => voteTally[m].abstain);

  // Chart.js bar chart
  const ctx = document.getElementById("voteBreakdownChart").getContext("2d");
  new Chart(ctx, {
    type: "bar",
    data: {
      labels: members,
      datasets: [
        {
          label: "Yes Votes",
          data: yesCounts,
          backgroundColor: "#2ecc71"
        },
        {
          label: "No Votes",
          data: noCounts,
          backgroundColor: "#e74c3c"
        },
        {
          label: "Abstain Votes",
          data: abstainCounts,
          backgroundColor: "#f1c40f"
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: "Board Member Voting Totals (All Agendas)"
        },
        legend: {
          position: "top"
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: "Vote Count"
          }
        }
      }
    }
  });

  // Populate table
  const tbody = document.querySelector("#voteTable tbody");
  members.forEach(member => {
    const yes = voteTally[member].yes;
    const no = voteTally[member].no;
    const abstain = voteTally[member].abstain;
    const total = yes + no + abstain;
    const row = `
      <tr>
        <td>${member}</td>
        <td>${yes}</td>
        <td>${no}</td>
        <td>${abstain}</td>
        <td>${total}</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });

  $('#voteTable').DataTable();
})();
</script>

</body>
</html>
